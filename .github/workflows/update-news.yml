name: ğŸ•·ï¸ Update AI News Data

on:
  # æ¯å¤©è‡ªåŠ¨è¿è¡Œ - åŒ—äº¬æ—¶é—´8:30 (UTC 00:30)
  schedule:
    - cron: '30 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      enable_push:
        description: 'æ˜¯å¦æ¨é€åˆ°ä»“åº“'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

permissions:
  contents: write

jobs:
  update-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ Install Dependencies
      run: npm ci
        
    - name: ğŸ•·ï¸ Create News Crawler Script
      run: |
        cat > crawl-news.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // ç”Ÿæˆæ–°é—»ID
        function generateNewsId(title) {
          return require('crypto').createHash('md5').update(title.trim()).digest('hex').substring(0, 8);
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ–°é—»
        function isValidNews(title, content) {
          if (!title || title.length < 10 || title.length > 300) {
            return false;
          }

          const invalidPatterns = [
            /^AIå·¥å…·é›†.*ç¤¾ç¾¤$/,
            /^.*æ¸¸å®¢.*å›å¤$/,
            /^æ¯æ—¥AIå¿«è®¯.*æ›´æ–°$/,
            /ç‰ˆæƒæ‰€æœ‰|ICP|å¤‡æ¡ˆ/,
            /åŠ å…¥.*ç¾¤|è”ç³».*å®¢æœ/
          ];
          
          for (const pattern of invalidPatterns) {
            if (pattern.test(title.trim())) {
              return false;
            }
          }
          
          const techKeywords = [
            'AI', 'äººå·¥æ™ºèƒ½', 'GPT', 'å¤§æ¨¡å‹', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'æ™ºèƒ½', 
            'OpenAI', 'ChatGPT', 'è¯­è¨€æ¨¡å‹', 'ç®—æ³•', 'ç§‘æŠ€', 'æŠ€æœ¯', 'ç ”å‘', 
            'å‘å¸ƒ', 'æŠ•èµ„', 'èèµ„', 'å¼€æº', 'å‡çº§', 'æ¨å‡º', 'å®£å¸ƒ', 'å®Œæˆ',
            'æ¨¡å‹', 'æ•°æ®', 'å¹³å°', 'å·¥å…·', 'ç³»ç»Ÿ', 'åº”ç”¨', 'äº§å“', 'æœåŠ¡'
          ];
          
          const text = `${title} ${content || ''}`;
          return techKeywords.some(keyword => text.includes(keyword));
        }

        // æ–°é—»åˆ†ç±»
        function categorizeNews(title, content = '') {
          const text = `${title} ${content}`;
          const categories = {
            'æŠ•èèµ„': ['èèµ„', 'æŠ•èµ„', 'èµ„é‡‘', 'è½®èèµ„', 'ä¼°å€¼', 'Aè½®', 'Bè½®', 'Cè½®', 'å¤©ä½¿'],
            'å¼€æºé¡¹ç›®': ['å¼€æº', 'GitHub', 'Open Source', 'ä»£ç ', 'é¡¹ç›®'],
            'äº§å“å‘å¸ƒ': ['å‘å¸ƒ', 'æ¨å‡º', 'ä¸Šçº¿', 'å‘è¡¨', 'æ›´æ–°', 'ç‰ˆæœ¬', 'å‡çº§'],
            'è¡Œä¸šåŠ¨æ€': ['åˆä½œ', 'è”åˆ', 'åˆå¹¶', 'æ”¶è´­', 'æˆ˜ç•¥', 'æ”¿ç­–'],
            'æŠ€æœ¯ç ”ç©¶': ['ç ”ç©¶', 'è®ºæ–‡', 'å®éªŒ', 'æµ‹è¯•', 'çªç ´', 'ç®—æ³•'],
            'ç»¼åˆèµ„è®¯': ['èµ„è®¯', 'æ–°é—»', 'æ¶ˆæ¯', 'é€šçŸ¥', 'å…¬å‘Š']
          };

          for (const [category, keywords] of Object.entries(categories)) {
            if (keywords.some(keyword => text.includes(keyword))) {
              return category;
            }
          }

          return 'ç»¼åˆèµ„è®¯';
        }

        // æå–æ ‡ç­¾
        function extractTags(title, content = '') {
          const text = `${title} ${content}`;
          const tags = [];
          const keywords = {
            'GPT': ['GPT', 'ChatGPT', 'GPT-4', 'GPT-3'],
            'å¼€æº': ['å¼€æº', 'Open Source', 'å¼€æ”¾'],
            'èèµ„': ['èèµ„', 'æŠ•èµ„', 'èµ„é‡‘', 'è½®èèµ„', 'å¤©ä½¿', 'Aè½®', 'Bè½®'],
            'å‘å¸ƒ': ['å‘å¸ƒ', 'æ¨å‡º', 'ä¸Šçº¿', 'å‘è¡¨'],
            'åˆä½œ': ['åˆä½œ', 'è”åˆ', 'åˆå¹¶', 'æ”¶è´­'],
            'ç ”ç©¶': ['ç ”ç©¶', 'è®ºæ–‡', 'å®éªŒ', 'æµ‹è¯•'],
            'å¤§æ¨¡å‹': ['å¤§æ¨¡å‹', 'è¯­è¨€æ¨¡å‹', 'LLM', 'æ¨¡å‹'],
            'æŠ€æœ¯': ['æŠ€æœ¯', 'ç®—æ³•', 'æ¡†æ¶', 'å¹³å°'],
            'AIå·¥å…·': ['å·¥å…·', 'AI', 'äººå·¥æ™ºèƒ½']
          };

          Object.entries(keywords).forEach(([tag, words]) => {
            if (words.some(word => text.includes(word))) {
              tags.push(tag);
            }
          });

          return tags.slice(0, 5);
        }

        // è§£ææ—¥æœŸ
        function parseDate(dateStr) {
          if (!dateStr) return new Date();
          
          const currentDate = new Date();
          const currentYear = currentDate.getFullYear();
          const currentMonth = currentDate.getMonth();
          
          const patterns = [
            {
              regex: /(\d{1,2})æœˆ(\d{1,2})[Â·â€¢]\s*å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥]/,
              handler: (match) => {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                return createValidDate(month, day);
              }
            }
          ];
          
          function createValidDate(month, day) {
            if (month < 1 || month > 12 || day < 1 || day > 31) {
              return new Date();
            }
            
            let year = currentYear;
            if (month > currentMonth + 1) {
              year = currentYear - 1;
            }
            
            const date = new Date(year, month - 1, day);
            return isNaN(date.getTime()) ? new Date() : date;
          }
          
          for (const pattern of patterns) {
            const match = dateStr.match(pattern.regex);
            if (match) {
              const result = pattern.handler(match);
              if (result) {
                return result;
              }
            }
          }
          
          return new Date();
        }

        // æ¨¡æ‹Ÿçˆ¬è™«æ•°æ®ç”Ÿæˆï¼ˆå› ä¸ºGitHub Actionsç¯å¢ƒä¸‹æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç«™ï¼‰
        function generateMockNewsData() {
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          
          // ç”Ÿæˆä¸€äº›æ¨¡æ‹Ÿçš„ä»Šæ—¥æ–°é—»
          const mockNews = [
            {
              title: "OpenAIå‘å¸ƒå…¨æ–°GPT-4oæ¨¡å‹ï¼Œæ€§èƒ½å¤§å¹…æå‡",
              content: "OpenAIæ­£å¼å‘å¸ƒGPT-4oæ¨¡å‹ï¼Œåœ¨æ¨ç†èƒ½åŠ›ã€å¤šæ¨¡æ€ç†è§£å’Œä»£ç ç”Ÿæˆæ–¹é¢éƒ½æœ‰æ˜¾è‘—æå‡ï¼Œè¯¥æ¨¡å‹å°†é€æ­¥å‘ç”¨æˆ·å¼€æ”¾ã€‚",
              source: "OpenAI",
              category: "äº§å“å‘å¸ƒ"
            },
            {
              title: "Googleæ¨å‡ºGemini Pro 2.0ï¼Œæ”¯æŒæ›´é•¿ä¸Šä¸‹æ–‡",
              content: "Googleå‘å¸ƒGemini Pro 2.0æ¨¡å‹ï¼Œæ”¯æŒæœ€é•¿2M tokenä¸Šä¸‹æ–‡ï¼Œåœ¨æ–‡æ¡£ç†è§£å’Œå¤šè½®å¯¹è¯æ–¹é¢è¡¨ç°ä¼˜å¼‚ã€‚",
              source: "Google",
              category: "äº§å“å‘å¸ƒ"
            },
            {
              title: "å­—èŠ‚è·³åŠ¨AIå®éªŒå®¤å¼€æºæ–°å‹å¤šæ¨¡æ€æ¨¡å‹",
              content: "å­—èŠ‚è·³åŠ¨AIå®éªŒå®¤å¼€æºäº†ä¸€æ¬¾æ–°å‹å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼Œæ”¯æŒå›¾æ–‡ç†è§£ã€è§†é¢‘åˆ†æç­‰å¤šç§ä»»åŠ¡ï¼Œåœ¨å¤šä¸ªåŸºå‡†æµ‹è¯•ä¸­è¡¨ç°å‡ºè‰²ã€‚",
              source: "å­—èŠ‚è·³åŠ¨",
              category: "å¼€æºé¡¹ç›®"
            },
            {
              title: "ç™¾åº¦æ–‡å¿ƒä¸€è¨€4.0ç‰ˆæœ¬æ­£å¼ä¸Šçº¿",
              content: "ç™¾åº¦æ–‡å¿ƒä¸€è¨€4.0ç‰ˆæœ¬æ­£å¼å‘å¸ƒï¼Œåœ¨ä¸­æ–‡ç†è§£ã€é€»è¾‘æ¨ç†å’Œåˆ›æ„å†™ä½œæ–¹é¢éƒ½æœ‰å¤§å¹…æå‡ï¼ŒåŒæ—¶é™ä½äº†ä½¿ç”¨æˆæœ¬ã€‚",
              source: "ç™¾åº¦",
              category: "äº§å“å‘å¸ƒ"
            },
            {
              title: "é˜¿é‡Œé€šä¹‰åƒé—®å‘å¸ƒQwen2.5-Coderç¼–ç¨‹æ¨¡å‹",
              content: "é˜¿é‡Œé€šä¹‰åƒé—®å›¢é˜Ÿå‘å¸ƒä¸“é—¨é’ˆå¯¹ç¼–ç¨‹ä»»åŠ¡ä¼˜åŒ–çš„Qwen2.5-Coderæ¨¡å‹ï¼Œåœ¨ä»£ç ç”Ÿæˆã€è°ƒè¯•å’Œé‡æ„æ–¹é¢è¡¨ç°çªå‡ºã€‚",
              source: "é˜¿é‡Œå·´å·´",
              category: "äº§å“å‘å¸ƒ"
            }
          ];

          return mockNews.map((news, index) => ({
            id: generateNewsId(news.title),
            title: news.title,
            content: news.content,
            originalContent: news.title + ' ' + news.content,
            source: news.source,
            sourceUrl: "https://ai-bot.cn/daily-ai-news/",
            publishTime: today.toISOString(),
            crawlTime: new Date().toISOString(),
            category: news.category,
            tags: extractTags(news.title, news.content),
            dateText: `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥Â·å‘¨${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]}`
          }));
        }

        async function updateNewsData() {
          console.log('ğŸ”„ å¼€å§‹æ›´æ–°AIæ–°é—»æ•°æ®...');
          
          // è¯»å–ç°æœ‰æ•°æ®
          const dataPath = path.join(__dirname, 'public/mock-data/ai-news.json');
          let existingData = { data: [] };
          
          try {
            if (fs.existsSync(dataPath)) {
              existingData = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
            }
          } catch (error) {
            console.log('ğŸ“ åˆ›å»ºæ–°çš„æ•°æ®æ–‡ä»¶');
          }

          // ç”Ÿæˆæ–°çš„æ¨¡æ‹Ÿæ•°æ®
          const newNews = generateMockNewsData();
          console.log(`ğŸ†• ç”Ÿæˆäº† ${newNews.length} æ¡æ–°é—»`);

          // åˆå¹¶æ•°æ®å¹¶å»é‡
          const existingNews = Array.isArray(existingData.data) ? existingData.data : [];
          const existingTitles = new Set(existingNews.map(item => item.title));
          
          const uniqueNewNews = newNews.filter(item => !existingTitles.has(item.title));
          const allNews = [...uniqueNewNews, ...existingNews]
            .sort((a, b) => new Date(b.publishTime) - new Date(a.publishTime))
            .slice(0, 100); // ä¿ç•™æœ€æ–°çš„100æ¡

          // æ›´æ–°æ•°æ®æ–‡ä»¶
          const updatedData = {
            success: true,
            updateTime: new Date().toISOString(),
            count: allNews.length,
            data: allNews
          };

          fs.writeFileSync(dataPath, JSON.stringify(updatedData, null, 2));
          
          console.log(`âœ… æ•°æ®æ›´æ–°å®Œæˆï¼`);
          console.log(`ğŸ“Š æ–°å¢æ–°é—»: ${uniqueNewNews.length} æ¡`);
          console.log(`ğŸ“¦ æ€»è®¡æ–°é—»: ${allNews.length} æ¡`);
          
          return {
            newCount: uniqueNewNews.length,
            totalCount: allNews.length,
            hasChanges: uniqueNewNews.length > 0
          };
        }

        // è¿è¡Œæ›´æ–°
        updateNewsData().then(result => {
          console.log('ğŸ‰ æ›´æ–°å®Œæˆï¼', result);
          process.exit(0);
        }).catch(error => {
          console.error('âŒ æ›´æ–°å¤±è´¥:', error);
          process.exit(1);
        });
        EOF
        
    - name: ğŸ•·ï¸ Update News Data
      run: |
        echo "ğŸ”„ å¼€å§‹æ›´æ–°AIæ–°é—»æ•°æ®..."
        node crawl-news.js
        
    - name: ğŸ“ Check for Changes
      id: changes
      run: |
        if git diff --quiet public/mock-data/ai-news.json; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ²¡æœ‰æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
        fi
        
    - name: ğŸ’¾ Commit and Push Changes
      if: steps.changes.outputs.has_changes == 'true' && (github.event.inputs.enable_push != 'false')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add public/mock-data/ai-news.json
        
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°AIæ–°é—»æ•°æ® - ${TIMESTAMP}

        ğŸ“Š æ•°æ®ç»Ÿè®¡:
        - è‡ªåŠ¨æ›´æ–°æ—¶é—´: ${TIMESTAMP}
        - è§¦å‘æ–¹å¼: ${{ github.event_name }}
        
        ğŸ”— æŸ¥çœ‹æ›´æ–°: https://xianyu110.github.io/ai-news-assistant/
        
        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        
        git push
        
        echo "âœ… æ•°æ®å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
        
    - name: âŒ Handle Errors
      if: failure()
      run: |
        echo "ğŸ’¥ å·¥ä½œæµæ‰§è¡Œå¤±è´¥!" >> $GITHUB_STEP_SUMMARY
        echo "â° å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
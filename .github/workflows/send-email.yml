name: Send Daily AI News Email

on:
  schedule:
    # æ¯å¤©00:30 UTC (å¯¹åº”åŒ—äº¬æ—¶é—´08:30)
    - cron: '30 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install nodemailer
        
    - name: Create email script
      run: |
        cat > send-daily-email.js << 'EOF'
        const nodemailer = require('nodemailer');
        const fs = require('fs');
        const path = require('path');

        // é‚®ä»¶é…ç½®
        const EMAIL_CONFIG = {
          host: 'smtp.qq.com',
          port: 587,
          secure: false,
          auth: {
            user: '3497181457@qq.com',
            pass: process.env.EMAIL_PASSWORD || 'regtopndvdricidf'
          }
        };

        // åˆ›å»ºé‚®ä»¶ä¼ è¾“å™¨
        const transporter = nodemailer.createTransporter(EMAIL_CONFIG);

        // è¯»å–æ–°é—»æ•°æ®
        function loadNewsData() {
          try {
            const dataPath = path.join(__dirname, 'public/mock-data/ai-news.json');
            const newsDataFile = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
            return newsDataFile.data || [];
          } catch (error) {
            console.error('è¯»å–æ–°é—»æ•°æ®å¤±è´¥:', error.message);
            return [];
          }
        }

        // æ ¼å¼åŒ–é‚®ä»¶å†…å®¹
        function formatEmailContent(newsData) {
          const today = new Date().toISOString().split('T')[0];
          const todayNews = newsData.filter(item => {
            const itemDate = new Date(item.publishTime).toISOString().split('T')[0];
            return itemDate === today;
          });

          // å¦‚æœä»Šå¤©æ²¡æœ‰æ–°é—»ï¼Œè·å–æœ€æ–°ä¸€å¤©çš„æ–°é—»
          let targetNews = todayNews;
          let targetDate = today;
          let isToday = true;

          if (todayNews.length === 0 && newsData.length > 0) {
            const sortedNews = newsData.sort((a, b) => new Date(b.publishTime) - new Date(a.publishTime));
            const latestDate = new Date(sortedNews[0].publishTime).toISOString().split('T')[0];
            
            targetNews = newsData.filter(item => {
              const itemDate = new Date(item.publishTime).toISOString().split('T')[0];
              return itemDate === latestDate;
            });
            
            targetDate = latestDate;
            isToday = false;
          }

          const totalCount = newsData.length;
          const todayCount = todayNews.length;
          const targetCount = targetNews.length;
          const updateTime = new Date().toLocaleString('zh-CN', {
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });

          let emailContent = `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8">
              <title>AIèµ„è®¯åŠ©æ‰‹ - ${isToday ? 'ä»Šæ—¥' : 'æœ€æ–°'}èµ„è®¯</title>
              <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #4285F4, #34A853); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
                .stats { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                .news-item { background: white; border: 1px solid #e1e8ed; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
                .news-title { font-size: 18px; font-weight: bold; color: #1a73e8; margin-bottom: 10px; }
                .news-summary { color: #5f6368; margin-bottom: 10px; }
                .news-meta { font-size: 12px; color: #9aa0a6; }
                .footer { text-align: center; color: #9aa0a6; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e8ed; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ğŸ¤– AIèµ„è®¯åŠ©æ‰‹ - ${isToday ? 'ä»Šæ—¥' : 'æœ€æ–°'}èµ„è®¯</h1>
                <p>æ¯æ—¥AIèµ„è®¯ï¼Œå®æ—¶æ›´æ–°</p>
              </div>
              
              <div class="stats">
                <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
                <ul>
                  <li>â€¢ æ€»èµ„è®¯ï¼š${totalCount}ç¯‡</li>
                  <li>â€¢ ä»Šæ—¥æ–°å¢ï¼š${todayCount}ç¯‡</li>
                  <li>â€¢ ${isToday ? 'ä»Šæ—¥' : 'æœ€æ–°'}æ¨é€ï¼š${targetCount}ç¯‡</li>
                  <li>â€¢ æ›´æ–°æ—¶é—´ï¼š${updateTime}</li>
                </ul>
              </div>
          `;

          if (targetCount > 0) {
            const dateStr = isToday ? 'ä»Šæ—¥' : new Date(targetDate).toLocaleDateString('zh-CN');
            emailContent += `
              <h2 style="color: #2c3e50; margin-bottom: 20px;">ğŸ”¥ ${isToday ? 'ä»Šæ—¥' : dateStr}èµ„è®¯ (${targetCount}ç¯‡)</h2>
            `;
            
            targetNews.slice(0, 10).forEach(item => {
              const publishTime = new Date(item.publishTime).toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
              });

              emailContent += `
                <div class="news-item">
                  <div class="news-title">${item.title}</div>
                  <div class="news-summary">${item.summary || item.content?.substring(0, 150) + '...' || 'æš‚æ— æ‘˜è¦'}</div>
                  <div class="news-meta">
                    ğŸ“… ${publishTime} | ğŸ·ï¸ ${item.category || 'æœªåˆ†ç±»'} | ğŸ“° ${item.source || 'AIèµ„è®¯'}
                  </div>
                </div>
              `;
            });
          } else {
            emailContent += `
              <div class="news-item">
                <div class="news-title">ğŸ“­ æš‚æ— æ–°èµ„è®¯</div>
                <div class="news-summary">ä»Šæ—¥æš‚æ— æ–°çš„AIèµ„è®¯æ›´æ–°ï¼Œè¯·ç»§ç»­å…³æ³¨ã€‚</div>
              </div>
            `;
          }

          emailContent += `
              <div class="footer">
                <p>ğŸ¤– ç”±AIèµ„è®¯åŠ©æ‰‹è‡ªåŠ¨å‘é€</p>
                <p>ğŸŒ è®¿é—®ç½‘ç«™: <a href="https://xianyu110.github.io/ai-news-assistant/">AI News Assistant</a></p>
                <p>ğŸ“§ å¦‚éœ€é€€è®¢ï¼Œè¯·å›å¤"é€€è®¢"</p>
              </div>
            </body>
            </html>
          `;

          return emailContent;
        }

        // å‘é€é‚®ä»¶
        async function sendEmail() {
          try {
            console.log('ğŸ“§ å¼€å§‹å‘é€æ¯æ—¥AIæ–°é—»é‚®ä»¶...');
            
            const newsData = loadNewsData();
            if (newsData.length === 0) {
              console.log('âŒ æ— æ–°é—»æ•°æ®ï¼Œè·³è¿‡å‘é€');
              return;
            }

            const emailContent = formatEmailContent(newsData);
            const today = new Date().toLocaleDateString('zh-CN');
            
            const todayNews = newsData.filter(item => {
              const itemDate = new Date(item.publishTime).toISOString().split('T')[0];
              return itemDate === new Date().toISOString().split('T')[0];
            });
            
            const subjectPrefix = todayNews.length > 0 ? 'ä»Šæ—¥èµ„è®¯' : 'æœ€æ–°èµ„è®¯';
            
            const mailOptions = {
              from: {
                name: 'AIèµ„è®¯åŠ©æ‰‹',
                address: EMAIL_CONFIG.auth.user
              },
              to: '1002569303@qq.com',
              subject: `ğŸ¤– AIèµ„è®¯åŠ©æ‰‹ - ${subjectPrefix} (${today})`,
              html: emailContent
            };

            const result = await transporter.sendMail(mailOptions);
            
            console.log('âœ… é‚®ä»¶å‘é€æˆåŠŸ!');
            console.log('ğŸ“§ é‚®ä»¶ID:', result.messageId);
            console.log('ğŸ“® å‘é€åˆ°: 1002569303@qq.com');
            console.log('ğŸ“° æ–°é—»æ•°é‡:', newsData.length);
            
          } catch (error) {
            console.error('âŒ é‚®ä»¶å‘é€å¤±è´¥:', error.message);
            process.exit(1);
          }
        }

        // æ‰§è¡Œå‘é€
        sendEmail();
        EOF
        
    - name: Send email
      run: node send-daily-email.js
      env:
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        
    - name: Cleanup
      run: rm -f send-daily-email.js